<!doctype html>
<html>
<head>
Â  <meta charset="utf-8" />
Â  <title>BioCompare â€” Protein Comparison</title>
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <style>
Â  Â  :root{
Â  Â  Â  --accent: #0aa89e; /* teal accent requested */
Â  Â  Â  --muted: #6b7280;
Â  Â  Â  --bg-band: rgba(10,168,158,0.06); /* very faint teal band */
Â  Â  Â  --card: #ffffff;
Â  Â  Â  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
Â  Â  Â  --maxw:1100px;
Â  Â  }

Â  Â  /* Page base */
Â  Â  html,body{height:100%}
Â  Â  body{
Â  Â  Â  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
Â  Â  Â  max-width:var(--maxw);
Â  Â  Â  margin:20px auto;
Â  Â  Â  color:#0f1720;
Â  Â  Â  padding:0 16px 40px;
Â  Â  Â  background:#ffffff;
Â  Â  }

Â  Â  /* HERO: off-white band behind hero */
Â  Â  .hero-band {
Â  Â  Â  background: linear-gradient(180deg, var(--bg-band) 0%, rgba(255,255,255,0.65) 60%);
Â  Â  Â  padding:18px 14px;
Â  Â  Â  border-radius:10px;
Â  Â  Â  margin-bottom:16px;
Â  Â  Â  display:flex;
Â  Â  Â  align-items:center;
Â  Â  Â  justify-content:space-between;
Â  Â  Â  gap:14px;
Â  Â  }
Â  Â  .hero-left { display:flex; gap:12px; align-items:flex-start; }
Â  Â  .title-wrap { line-height:1; }
Â  Â  .site-title {
Â  Â  Â  margin:0;
Â  Â  Â  font-size:28px; /* larger title */
Â  Â  Â  font-weight:800;
Â  Â  Â  color:#0a3b36; /* darker teal-ish for text */
Â  Â  Â  letter-spacing:-0.4px;
Â  Â  Â  position:relative;
Â  Â  Â  /* soft embossed / inset look (subtle inner-shadow feel) */
Â  Â  Â  text-shadow: 0 1px 0 #ffffff, /* light top */
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 0 -1px 0 rgba(0,0,0,0.06); /* faint inner dark line */
Â  Â  }
Â  Â  .site-tagline { margin:6px 0 0; color:var(--muted); font-size:13px; }

Â  Â  /* subtle note box on the right of hero */
Â  Â  .note {
Â  Â  Â  font-size:13px;
Â  Â  Â  color:#334;
Â  Â  Â  background: linear-gradient(180deg, #ffffff, #fbfffe);
Â  Â  Â  border:1px solid rgba(10,168,158,0.12);
Â  Â  Â  padding:10px 14px;
Â  Â  Â  border-radius:10px;
Â  Â  Â  max-width:520px;
Â  Â  Â  box-shadow: 0 6px 18px rgba(10,20,20,0.03);
Â  Â  }
Â  Â  .note b { color:#0f1720; }

Â  Â  /* inputs and controls */
Â  Â  label{display:block;margin-top:12px;font-weight:600}
Â  Â  input[type="text"]{
Â  Â  Â  width:100%;
Â  Â  Â  padding:10px;
Â  Â  Â  border:1px solid #e6eef0;
Â  Â  Â  border-radius:8px;
Â  Â  Â  font-family:var(--mono);
Â  Â  Â  background: #fbfffe;
Â  Â  Â  box-shadow: 0 1px 0 rgba(0,0,0,0.02) inset;
Â  Â  }

Â  Â  .field-row { display:flex; gap:28px; align-items:flex-start; margin-top:12px; }
Â  Â  .field-row .input-col { flex:0 0 50%; }

Â  Â  /* Example card */
Â  Â  .example-box {
Â  Â  Â  position:relative; /* for copy button placement */
Â  Â  Â  background:#fbfffe;
Â  Â  Â  border:1px solid #e6eef0;
Â  Â  Â  border-radius:8px;
Â  Â  Â  padding:12px 12px 14px 12px;
Â  Â  Â  font-family:var(--mono);
Â  Â  Â  font-size:13px;
Â  Â  Â  color:#111;
Â  Â  Â  box-sizing:border-box;
Â  Â  Â  width:420px;
Â  Â  Â  max-width:48vw;
Â  Â  }

Â  Â  .example-title { font-weight:700; margin:0 0 8px; color:#0f1720; font-family:inherit; font-size:14px;}
Â  Â  .example-row { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
Â  Â  .example-row strong { width:18px; display:inline-block; font-weight:700; }

Â  Â  /* copy button inside example */
Â  Â  .example-copy-btn {
Â  Â  Â  position:absolute;
Â  Â  Â  right:10px;
Â  Â  Â  top:10px;
Â  Â  Â  background:var(--accent);
Â  Â  Â  color:#fff;
Â  Â  Â  border:0;
Â  Â  Â  padding:6px 10px;
Â  Â  Â  border-radius:8px;
Â  Â  Â  cursor:pointer;
Â  Â  Â  font-weight:700;
Â  Â  Â  font-size:12px;
Â  Â  Â  box-shadow:0 6px 20px rgba(10,20,20,0.06);
Â  Â  }
Â  Â  .example-copy-btn:active { transform:translateY(1px); }
Â  Â  .example-copy-btn[disabled]{ opacity:.6; cursor:default; }

Â  Â  .copy-id {
Â  Â  Â  display:inline-block;
Â  Â  Â  padding:2px 8px;
Â  Â  Â  border:1px solid #e6eef0;
Â  Â  Â  border-radius:6px;
Â  Â  Â  background:#ffffff;
Â  Â  Â  cursor:pointer;
Â  Â  Â  user-select:none;
Â  Â  Â  font-family:var(--mono);
Â  Â  Â  font-size:13px;
Â  Â  }
Â  Â  .copy-id:hover { background:#f0fdfa; border-color:#c8efea; }
Â  Â  .copy-id.copied { background:#eafff8; border-color:#8be4d9; }

Â  Â  .tooltip-copied {
Â  Â  Â  position:fixed;
Â  Â  Â  z-index:9999;
Â  Â  Â  pointer-events:none;
Â  Â  Â  background:var(--accent);
Â  Â  Â  color:#fff;
Â  Â  Â  padding:6px 8px;
Â  Â  Â  border-radius:6px;
Â  Â  Â  font-size:12px;
Â  Â  Â  box-shadow:0 6px 18px rgba(10,20,20,0.12);
Â  Â  Â  opacity:0;
Â  Â  Â  transform:translate(-50%, -6px);
Â  Â  Â  transition:opacity .15s ease, transform .15s ease;
Â  Â  }

Â  Â  /* grid layout to place example box at far right spanning both inputs */
Â  Â  .fields-grid { display:grid; grid-template-columns: 1fr auto; column-gap:28px; row-gap:12px; align-items:start; }
Â  Â  .fields-grid .input-col { grid-column:1; }
Â  Â  .fields-grid .example-span { grid-column:2; grid-row:1 / span 2; justify-self:end; }

Â  Â  button{
Â  Â  Â  margin-top:8px;
Â  Â  Â  padding:10px 14px;
Â  Â  Â  border-radius:8px;
Â  Â  Â  border:0;
Â  Â  Â  background:var(--accent);
Â  Â  Â  color:#fff;
Â  Â  Â  cursor:pointer;
Â  Â  Â  font-weight:700;
Â  Â  }
Â  Â  button:disabled{opacity:.6;cursor:default}

Â  Â  .meta{font-size:13px;color:var(--muted);margin-top:8px}
Â  Â  .spinner{
Â  Â  Â  display:inline-block;width:12px;height:12px;border-radius:50%;
Â  Â  Â  border:2px solid rgba(0,0,0,0.12);border-top-color:var(--accent);
Â  Â  Â  animation:spin .8s linear infinite;vertical-align:middle;margin-left:8px
Â  Â  }
Â  Â  @keyframes spin{to{transform:rotate(360deg)}}

Â  Â  /* layout */
Â  Â  .container { display:flex; gap:18px; margin-top:14px; align-items:flex-start; }
Â  Â  .left { width:160px; }
Â  Â  .left .controls {
Â  Â  Â  background: linear-gradient(180deg, #ffffff, #fbfffe);
Â  Â  Â  border:1px solid #eef6f4;
Â  Â  Â  border-radius:10px;
Â  Â  Â  padding:12px;
Â  Â  Â  box-shadow:0 6px 18px rgba(10,20,20,0.02);
Â  Â  }
Â  Â  .icon-btn { display:flex; align-items:center; gap:8px; padding:8px; border-radius:8px; cursor:pointer; margin-bottom:8px; user-select:none; transition:background .12s, color .12s; }
Â  Â  .icon-btn:hover { background:rgba(10,168,158,0.06); }
Â  Â  .icon-btn.active { background:var(--accent); color:#fff; }
Â  Â  .icon-emoji { font-size:20px; width:28px; text-align:center; }
Â  Â  .small { font-size:13px; color:#444; }

Â  Â  .right { flex:1; min-height:320px; }
Â  Â  .panel { border-radius:10px; border:1px solid #eef6f4; padding:14px; margin-bottom:12px; background:var(--card); box-shadow:0 6px 18px rgba(10,20,20,0.03); }
Â  Â  .panel h2 { margin:0 0 8px; font-size:15px; display:flex; justify-content:space-between; align-items:center; }
Â  Â  .venn-container { width:100%; height:300px; display:flex; align-items:center; justify-content:center; }
Â  Â  .stats { font-size:13px; color:#333; margin-top:8px; }

Â  Â  /* table panel (vertical listing) */
Â  Â  .table-panel { display:none; border-radius:10px; border:1px solid #eef6f4; padding:12px; background:var(--card); box-shadow:0 6px 18px rgba(10,20,20,0.03); margin-bottom:12px; }
Â  Â  .table-actions { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
Â  Â  .download-btn { background:#0a7f72; color:#fff; border:0; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700; }
Â  Â  .download-btn:disabled { opacity:.6; cursor:default; }
Â  Â  table.compare { width:100%; border-collapse:collapse; font-size:13px; }
Â  Â  table.compare th, table.compare td { text-align:left; padding:8px 10px; border-bottom:1px solid #eef6f4; }
Â  Â  table.compare th { font-weight:700; background: #fbfffe; position:sticky; top:0; z-index:1; }
Â  Â  .no-data { color:var(--muted); padding:12px 0; }

Â  Â  #output { white-space:pre-wrap; background:#0f1720; color:#e6eef8; padding:12px; border-radius:8px; margin-top:14px; min-height:140px; overflow:auto; border:1px solid #253046; display:none; }

Â  Â  /* table comparison columns */
Â  Â  .compare-headers { display:flex; gap:12px; }
Â  Â  .col { flex:1; border:1px solid #edf7f6; border-radius:8px; padding:10px; min-height:140px; max-height:320px; overflow:auto; background:#fbfffe; }
Â  Â  .col h4 { margin:0 0 6px; font-size:13px; color:#0f1720; }
Â  Â  .item { font-family:var(--mono); font-size:13px; padding:6px 0; border-bottom:1px dashed rgba(0,0,0,0.04); color:#111; }

Â  Â  .hint { font-size:13px; color:var(--muted); margin-top:8px; }

Â  Â  /* responsive */
Â  Â  @media (max-width:880px) {
Â  Â  Â  .container { flex-direction:column; }
Â  Â  Â  .left { width:100%; order:2; }
Â  Â  Â  .right { order:1; }
Â  Â  Â  .note { max-width:100%; }
Â  Â  Â  .site-title { font-size:22px; }
Â  Â  Â  .field-row { flex-direction:column; align-items:stretch; }
Â  Â  Â  .field-row .input-col { flex:1 1 auto; }
Â  Â  Â  .fields-grid { display:block; }
Â  Â  Â  .example-box { width:auto; max-width:100%; }
Â  Â  Â  table.compare th, table.compare td { padding:8px 6px; }
Â  Â  }
Â  </style>

Â  Â  <script src="https://unpkg.com/d3@5"></script>
Â  <script src="https://unpkg.com/venn.js@0.2.20/build/venn.min.js"></script>
</head>
<body>
Â  Â  <div class="hero-band" role="banner" aria-label="BioCompare header">
Â  Â  <div class="hero-left">
Â  Â  Â  <div class="title-wrap">
Â  Â  Â  Â  <h1 class="site-title">BioCompare</h1>
Â  Â  Â  Â  <p class="site-tagline">Quickly explore and compare proteins from multiple trusted sources.</p>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="note" aria-hidden="false">
Â  Â  Â  <div><strong>Demo sources:</strong> Ensembl, UniProt, and NCBI Gene.</div>
Â  Â  Â  <div style="margin-top:6px;color:#334;font-size:13px;">
Â  Â  Â  Â  Some annotations may be incomplete â€” the aggregation pipeline is under active development and will be expanded in upcoming releases.
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  Â  <div>
Â  Â  <div class="fields-grid">
Â  Â  Â  <div class="input-col">
Â  Â  Â  Â  <label for="ensembl1">Ensembl ID A</label>
Â  Â  Â  Â  <input id="ensembl1" type="text" placeholder="ENSG00000141510" />
Â  Â  Â  </div>

Â  Â  Â  <div class="example-box example-span" aria-label="Examples">
Â  Â  Â  Â  <button class="example-copy-btn" id="copyExampleBtn" title="Copy example IDs">Copy example</button>
Â  Â  Â  Â  <div class="example-title">Example to see the intersection representation.</div>

Â  Â  Â  Â  <div class="example-row"><strong>A</strong>: <span class="copy-id" data-copy="ENSG00000124610">ENSG00000124610</span></div>
Â  Â  Â  Â  <div class="example-row"><strong>B</strong>: <span class="copy-id" data-copy="ENSG00000168298">ENSG00000168298</span></div>
Â  Â  Â  </div>

Â  Â  Â  <div class="input-col">
Â  Â  Â  Â  <label for="ensembl2">Ensembl ID B</label>
Â  Â  Â  Â  <input id="ensembl2" type="text" placeholder="ENSG00000139618" />
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="meta">This page POSTS the two IDs to your server and uses the returned JSON for frontend comparisons and a comparison table.</div>
Â  Â  <button id="submit">Submit</button>
Â  Â  <span id="status" class="meta" aria-live="polite"></span>
Â  </div>

Â  <div class="container">
Â  Â  <div class="left">
Â  Â  Â  <div class="controls">
Â  Â  Â  Â  <div id="btn-goids" class="icon-btn" title="Compare by GO IDs">
Â  Â  Â  Â  Â  <span class="icon-emoji">ðŸ§¬</span>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <div style="font-weight:700">GO IDs</div>
Â  Â  Â  Â  Â  Â  <div class="small">Compare by GO identifiers</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="btn-goterms" class="icon-btn" title="Compare by GO Terms">
Â  Â  Â  Â  Â  <span class="icon-emoji">ðŸ“š</span>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <div style="font-weight:700">GO Terms</div>
Â  Â  Â  Â  Â  Â  <div class="small">Compare by GO term strings</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="btn-symbols" class="icon-btn" title="Compare by Gene Symbol">
Â  Â  Â  Â  Â  <span class="icon-emoji">ðŸ”¤</span>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <div style="font-weight:700">Gene Symbol</div>
Â  Â  Â  Â  Â  Â  <div class="small">Compare by gene symbol (fallback: Ensembl)</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="btn-table" class="icon-btn" title="Show comparison table (download CSV)">
Â  Â  Â  Â  Â  <span class="icon-emoji">ðŸ“‹</span>
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <div style="font-weight:700">Show Table</div>
Â  Â  Â  Â  Â  Â  <div class="small">Vertical table + Download CSV</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="hint">Click an option to open the right panel (A vs B) â€” venn + table.</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="right">
Â  Â  Â  Â  Â  Â  <div id="panel-goids" class="panel" style="display:none">
Â  Â  Â  Â  <h2>GO IDs <span id="goids-count"></span></h2>
Â  Â  Â  Â  <div id="venn-goids" class="venn-container" aria-hidden="true"></div>
Â  Â  Â  Â  <div id="goids-stats" class="stats"></div>

Â  Â  Â  Â  <div class="compare-headers" style="margin-top:12px">
Â  Â  Â  Â  Â  <div class="col" id="goids-col-a"><h4>A only</h4><div id="goids-a-list"></div></div>
Â  Â  Â  Â  Â  <div class="col" id="goids-col-both"><h4>Shared</h4><div id="goids-both-list"></div></div>
Â  Â  Â  Â  Â  <div class="col" id="goids-col-b"><h4>B only</h4><div id="goids-b-list"></div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="panel-goterms" class="panel" style="display:none">
Â  Â  Â  Â  <h2>GO Terms <span id="goterms-count"></span></h2>
Â  Â  Â  Â  <div id="venn-goterms" class="venn-container" aria-hidden="true"></div>
Â  Â  Â  Â  <div id="goterms-stats" class="stats"></div>

Â  Â  Â  Â  <div class="compare-headers" style="margin-top:12px">
Â  Â  Â  Â  Â  <div class="col" id="goterms-col-a"><h4>A only</h4><div id="goterms-a-list"></div></div>
Â  Â  Â  Â  Â  <div class="col" id="goterms-col-both"><h4>Shared</h4><div id="goterms-both-list"></div></div>
Â  Â  Â  Â  Â  <div class="col" id="goterms-col-b"><h4>B only</h4><div id="goterms-b-list"></div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="panel-symbols" class="panel" style="display:none">
Â  Â  Â  Â  <h2>Gene Symbol <span id="symbols-count"></span></h2>
Â  Â  Â  Â  <div id="venn-symbols" class="venn-container" aria-hidden="true"></div>
Â  Â  Â  Â  <div id="symbols-stats" class="stats"></div>

Â  Â  Â  Â  <div class="compare-headers" style="margin-top:12px">
Â  Â  Â  Â  Â  <div class="col" id="symbols-col-a"><h4>A only</h4><div id="symbols-a-list"></div></div>
Â  Â  Â  Â  Â  <div class="col" id="symbols-col-both"><h4>Shared</h4><div id="symbols-both-list"></div></div>
Â  Â  Â  Â  Â  <div class="col" id="symbols-col-b"><h4>B only</h4><div id="symbols-b-list"></div></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="table-panel" class="table-panel" role="region" aria-label="Comparison table">
Â  Â  Â  Â  <div class="table-actions">
Â  Â  Â  Â  Â  <button id="downloadCsvBtn" class="download-btn" disabled>Download CSV</button>
Â  Â  Â  Â  Â  <div class="meta" id="table-meta" style="margin-left:8px;color:var(--muted)">No data yet. Click Submit then Show Table.</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="table-container" aria-live="polite">
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="output" aria-hidden="true">Server response will appear here...</div>
Â  Â  </div>
Â  </div>

<script>
/* Endpoint */
const API_ENDPOINT = "https://dev-playground-8c4p.onrender.com";

/* DOM refs */
const en1 = document.getElementById('ensembl1');
const en2 = document.getElementById('ensembl2');
const btn = document.getElementById('submit');
const out = document.getElementById('output');
const status = document.getElementById('status');

const btnGoIds = document.getElementById('btn-goids');
const btnGoTerms = document.getElementById('btn-goterms');
const btnSymbols = document.getElementById('btn-symbols');
const btnTable = document.getElementById('btn-table');

const panelGoIds = document.getElementById('panel-goids');
const panelGoTerms = document.getElementById('panel-goterms');
const panelSymbols = document.getElementById('panel-symbols');
const tablePanel = document.getElementById('table-panel');

const goidsAList = document.getElementById('goids-a-list');
const goidsBothList = document.getElementById('goids-both-list');
const goidsBList = document.getElementById('goids-b-list');

const gotermsAList = document.getElementById('goterms-a-list');
const gotermsBothList = document.getElementById('goterms-both-list');
const gotermsBList = document.getElementById('goterms-b-list');

const symbolsAList = document.getElementById('symbols-a-list');
const symbolsBothList = document.getElementById('symbols-both-list');
const symbolsBList = document.getElementById('symbols-b-list');

const goidsCount = document.getElementById('goids-count');
const gotermsCount = document.getElementById('goterms-count');
const symbolsCount = document.getElementById('symbols-count');

const goidsStats = document.getElementById('goids-stats');
const gotermsStats = document.getElementById('goterms-stats');
const symbolsStats = document.getElementById('symbols-stats');

const downloadCsvBtn = document.getElementById('downloadCsvBtn');
const tableContainer = document.getElementById('table-container');
const tableMeta = document.getElementById('table-meta');

let lastResponse = null;

/* small helpers */
function setBusy(b, msg) {
Â  btn.disabled = b;
Â  status.textContent = msg || "";
Â  const existing = document.querySelector('.spinner');
Â  if (b && !existing) {
Â  Â  const s = document.createElement('span'); s.className = 'spinner'; status.appendChild(s);
Â  } else if (!b && existing) existing.remove();
}

function tryPretty(text) {
Â  try { return JSON.stringify(JSON.parse(text), null, 2); } catch(e) { return text; }
}

async function postJSON(body){
Â  return fetch(API_ENDPOINT, {
Â  Â  method: 'POST',
Â  Â  headers: {'Content-Type': 'application/json', 'Accept': '*/*'},
Â  Â  body: JSON.stringify(body)
Â  });
}

async function getFallback(params){
Â  const url = new URL(API_ENDPOINT);
Â  Object.keys(params).forEach(k => url.searchParams.set(k, params[k] || ''));
Â  return fetch(url.toString(), {method:'GET', headers:{'Accept':'*/*'}});
}

/* normalize values (trim, collapse whitespace) */
function normalizeString(x) {
Â  if (x === null || x === undefined) return "";
Â  return String(x).trim();
}
function normalizeGOId(x) { return normalizeString(x).toUpperCase(); }
function normalizeGOTerm(x) { return normalizeString(x); }
function normalizeSymbol(x) { return normalizeString(x); }

/* build arrays/sets for each axis from response */
function buildSets(resp, axis) {
Â  if (!resp || !resp.annotations || resp.annotations.length < 2) return null;
Â  const a0 = resp.annotations[0], a1 = resp.annotations[1];

Â  if (axis === 'go_ids') {
Â  Â  const arrA = Array.isArray(a0.go_ids) ? a0.go_ids.map(normalizeGOId).filter(Boolean) : [];
Â  Â  const arrB = Array.isArray(a1.go_ids) ? a1.go_ids.map(normalizeGOId).filter(Boolean) : [];
Â  Â  return { arrA, arrB, setA: new Set(arrA), setB: new Set(arrB) };
Â  } else if (axis === 'go_terms') {
Â  Â  const arrA = Array.isArray(a0.go_terms) ? a0.go_terms.map(normalizeGOTerm).filter(Boolean) : [];
Â  Â  const arrB = Array.isArray(a1.go_terms) ? a1.go_terms.map(normalizeGOTerm).filter(Boolean) : [];
Â  Â  return { arrA, arrB, setA: new Set(arrA), setB: new Set(arrB) };
Â  } else if (axis === 'symbol') {
Â  Â  const valA = (a0.gene_symbol && a0.gene_symbol.trim()) ? a0.gene_symbol.trim() : a0.ensembl_id;
Â  Â  const valB = (a1.gene_symbol && a1.gene_symbol.trim()) ? a1.gene_symbol.trim() : a1.ensembl_id;
Â  Â  return { arrA: [normalizeSymbol(valA)], arrB: [normalizeSymbol(valB)], setA: new Set([valA]), setB: new Set([valB]) };
Â  }
Â  return null;
}

/* set helpers */
function setIntersection(A,B){ const out=new Set(); for(const x of A) if(B.has(x)) out.add(x); return out; }
function setDifference(A,B){ const out=new Set(); for(const x of A) if(!B.has(x)) out.add(x); return out; }
function unionSorted(A,B){ return Array.from(new Set([...A,...B])).sort(); }

/* draw venn */
function drawVenn(containerId, setA, setB, labelA, labelB, statsEl, countSpan) {
Â  const container = d3.select("#" + containerId);
Â  container.selectAll("*").remove();

Â  const inter = setIntersection(setA, setB);
Â  const data = [
Â  Â  { sets: [0], size: setA.size, label: labelA },
Â  Â  { sets: [1], size: setB.size, label: labelB },
Â  Â  { sets: [0,1], size: inter.size, label: labelA + " âˆ© " + labelB }
Â  ];

Â  try {
Â  Â  venn.VennDiagram().width(container.node().clientWidth).height(container.node().clientHeight)(container.datum(data), data);
Â  } catch(e) {
Â  Â  container.selectAll("*").remove();
Â  }

Â  const onlyA = setDifference(setA, setB).size;
Â  const onlyB = setDifference(setB, setA).size;
Â  const unionSize = unionSorted(setA, setB).length;

Â  statsEl.innerHTML = `<strong>${labelA} only:</strong> ${onlyA} &nbsp;&nbsp; <strong>Intersection:</strong> ${inter.size} &nbsp;&nbsp; <strong>${labelB} only:</strong> ${onlyB} <br><strong>Union (unique):</strong> ${unionSize}`;

Â  if (countSpan) countSpan.textContent = `(${setA.size} , ${setB.size})`;

Â  return {
Â  Â  onlyA: Array.from(setDifference(setA, setB)).sort(),
Â  Â  onlyB: Array.from(setDifference(setB, setA)).sort(),
Â  Â  shared: Array.from(inter).sort()
Â  };
}

/* render column lists */
function renderColumnList(containerEl, items) {
Â  containerEl.innerHTML = '';
Â  if (!items || items.length === 0) {
Â  Â  containerEl.innerHTML = '<div class="item" style="color:#888">â€”</div>';
Â  Â  return;
Â  }
Â  for (const it of items) {
Â  Â  const d = document.createElement('div');
Â  Â  d.className = 'item';
Â  Â  d.textContent = it;
Â  Â  containerEl.appendChild(d);
Â  }
}

/* collapse/show panels and manage active classes */
function collapseAll() {
Â  panelGoIds.style.display = 'none';
Â  panelGoTerms.style.display = 'none';
Â  panelSymbols.style.display = 'none';
Â  tablePanel.style.display = 'none';
Â  out.style.display = 'none';
Â  [btnGoIds, btnGoTerms, btnSymbols, btnTable].forEach(b => b.classList.remove('active'));
}

function showPanel(axis) {
Â  if (!lastResponse) { alert('No server response stored yet. Click Submit.'); return; }
Â  if (!lastResponse.annotations || lastResponse.annotations.length < 2) { alert('Server response must contain exactly two annotations (A and B).'); return; }

Â  collapseAll();

Â  if (axis === 'go_ids') {
Â  Â  btnGoIds.classList.add('active');
Â  Â  panelGoIds.style.display = 'block';
Â  Â  const { setA, setB } = buildSets(lastResponse, 'go_ids');
Â  Â  const res = drawVenn('venn-goids', setA, setB, 'A', 'B', goidsStats, goidsCount);
Â  Â  renderColumnList(goidsAList, res.onlyA);
Â  Â  renderColumnList(goidsBothList, res.shared);
Â  Â  renderColumnList(goidsBList, res.onlyB);
Â  } else if (axis === 'go_terms') {
Â  Â  btnGoTerms.classList.add('active');
Â  Â  panelGoTerms.style.display = 'block';
Â  Â  const { setA, setB } = buildSets(lastResponse, 'go_terms');
Â  Â  const res = drawVenn('venn-goterms', setA, setB, 'A', 'B', gotermsStats, gotermsCount);
Â  Â  renderColumnList(gotermsAList, res.onlyA);
Â  Â  renderColumnList(gotermsBothList, res.shared);
Â  Â  renderColumnList(gotermsBList, res.onlyB);
Â  } else if (axis === 'symbol') {
Â  Â  btnSymbols.classList.add('active');
Â  Â  panelSymbols.style.display = 'block';
Â  Â  const { setA, setB } = buildSets(lastResponse, 'symbol');
Â  Â  const res = drawVenn('venn-symbols', setA, setB, 'A', 'B', symbolsStats, symbolsCount);
Â  Â  renderColumnList(symbolsAList, res.onlyA);
Â  Â  renderColumnList(symbolsBothList, res.shared);
Â  Â  renderColumnList(symbolsBList, res.onlyB);
Â  } else if (axis === 'table') {
Â  Â  btnTable.classList.add('active');
Â  Â  tablePanel.style.display = 'block';
Â  Â  renderTableFromResponse(lastResponse);
Â  }
}

/* listeners */
btnGoIds.addEventListener('click', ()=> showPanel('go_ids'));
btnGoTerms.addEventListener('click', ()=> showPanel('go_terms'));
btnSymbols.addEventListener('click', ()=> showPanel('symbol'));
btnTable.addEventListener('click', ()=> showPanel('table'));

/* Submit logic (POST then GET fallback). Store response in lastResponse */
btn.addEventListener('click', async ()=> {
Â  out.textContent = '';
Â  collapseAll();
Â  const id1 = en1.value.trim(), id2 = en2.value.trim();
Â  if (!id1 && !id2) { out.textContent = 'Enter at least one Ensembl ID.'; return; }

Â  setBusy(true, 'Sending request...');
Â  let resp = null;
Â  try { resp = await postJSON({ id1: id1 || null, id2: id2 || null }); } catch(e){ resp = null; }

Â  if (!resp || (resp.status >= 400 && resp.status !== 400)) {
Â  Â  setBusy(true, 'POST failed â€” trying GET fallback...');
Â  Â  try { resp = await getFallback({ id1, id2 }); } catch(e){ resp = null; }
Â  }

Â  if (!resp) {
Â  Â  out.textContent = 'Request failed (network/CORS). Make sure server is running at https://dev-playground-8c4p.onrender.com';
Â  Â  setBusy(false, 'Error');
Â  Â  return;
Â  }

Â  const text = await resp.text();
Â  let parsed = null;
Â  try { parsed = JSON.parse(text); } catch(e) { parsed = null; }

Â  lastResponse = parsed || { raw: text };
Â  // keep output hidden by default (we use table)
Â  out.textContent = tryPretty(text);
Â  // replaced terse "HTTP 200 OK" message with a friendlier status string
Â  setBusy(false, `Response received â€” ${resp.status} ${resp.statusText}`);
});

/* ---------------------------
Â  Â TABLE + CSV generation
Â  Â --------------------------- */

/*
Â  Build rows in vertical fashion:
Â  Each row -> { ensembl_id, gene_symbol, go_id, go_term }
Â  If a gene has zero GO terms, include one row with empty go_id/go_term.
*/
function buildTableRowsFromResponse(resp) {
Â  const rows = [];
Â  if (!resp || !resp.annotations || resp.annotations.length === 0) return rows;

Â  for (const ann of resp.annotations) {
Â  Â  const enid = normalizeString(ann.ensembl_id || "");
Â  Â  const symbol = normalizeString(ann.gene_symbol || "");
Â  Â  // Use arrays (safely)
Â  Â  const goIds = Array.isArray(ann.go_ids) ? ann.go_ids.slice() : [];
Â  Â  const goTerms = Array.isArray(ann.go_terms) ? ann.go_terms.slice() : [];

Â  Â  // If there are GO IDs, list each on its own row (vertical)
Â  Â  if (goIds.length === 0) {
Â  Â  Â  rows.push({ ensembl_id: enid, gene_symbol: symbol, go_id: "", go_term: "" });
Â  Â  } else {
Â  Â  Â  // If goTerms length differs, fallback to empty strings for missing indexes
Â  Â  Â  for (let i = 0; i < goIds.length; i++) {
Â  Â  Â  Â  const gid = normalizeString(goIds[i] || "");
Â  Â  Â  Â  const gterm = normalizeString(goTerms[i] || "");
Â  Â  Â  Â  rows.push({ ensembl_id: enid, gene_symbol: symbol, go_id: gid, go_term: gterm });
Â  Â  Â  }
Â  Â  }
Â  }
Â  return rows;
}

/* Render the table (vertical list) into tableContainer and enable download */
function renderTableFromResponse(resp) {
Â  const rows = buildTableRowsFromResponse(resp);
Â  tableContainer.innerHTML = '';
Â  if (rows.length === 0) {
Â  Â  tableContainer.innerHTML = '<div class="no-data">No table data available for the current response.</div>';
Â  Â  downloadCsvBtn.disabled = true;
Â  Â  tableMeta.textContent = 'No data to download.';
Â  Â  return;
Â  }

Â  // Build HTML table
Â  const table = document.createElement('table');
Â  table.className = 'compare';
Â  const thead = document.createElement('thead');
Â  const headerRow = document.createElement('tr');
Â  ['Ensembl ID','Gene symbol','GO ID','GO term'].forEach(h => {
Â  Â  const th = document.createElement('th');
Â  Â  th.textContent = h;
Â  Â  headerRow.appendChild(th);
Â  });
Â  thead.appendChild(headerRow);
Â  table.appendChild(thead);

Â  const tbody = document.createElement('tbody');
Â  for (const r of rows) {
Â  Â  const tr = document.createElement('tr');
Â  Â  const td1 = document.createElement('td'); td1.textContent = r.ensembl_id; tr.appendChild(td1);
Â  Â  const td2 = document.createElement('td'); td2.textContent = r.gene_symbol; tr.appendChild(td2);
Â  Â  const td3 = document.createElement('td'); td3.textContent = r.go_id; tr.appendChild(td3);
Â  Â  const td4 = document.createElement('td'); td4.textContent = r.go_term; tr.appendChild(td4);
Â  Â  tbody.appendChild(tr);
Â  }
Â  table.appendChild(tbody);
Â  tableContainer.appendChild(table);

Â  // enable download and set meta text
Â  downloadCsvBtn.disabled = false;
Â  tableMeta.textContent = `${rows.length} rows â€” Download as CSV.`;
Â  // store last CSV data for quick download
Â  downloadCsvBtn._csvRows = rows;
}

/* Convert rows array -> CSV string */
function rowsToCsv(rows) {
Â  const esc = (v) => {
Â  Â  if (v === null || v === undefined) return '';
Â  Â  const s = String(v);
Â  Â  // escape quotes by doubling
Â  Â  if (s.includes('"') || s.includes(',') || s.includes('\n') || s.includes('\r')) {
Â  Â  Â  return '"' + s.replace(/"/g, '""') + '"';
Â  Â  }
Â  Â  return s;
Â  };
Â  const header = ['Ensembl ID','Gene symbol','GO ID','GO term'];
Â  const lines = [header.map(esc).join(',')];
Â  for (const r of rows) {
Â  Â  lines.push([r.ensembl_id, r.gene_symbol, r.go_id, r.go_term].map(esc).join(','));
Â  }
Â  return lines.join('\n');
}

/* Download CSV button handler */
downloadCsvBtn.addEventListener('click', () => {
Â  const rows = downloadCsvBtn._csvRows || [];
Â  if (!rows || rows.length === 0) return;
Â  const csv = rowsToCsv(rows);
Â  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
Â  const url = URL.createObjectURL(blob);
Â  const a = document.createElement('a');
Â  a.href = url;
Â  const ts = new Date().toISOString().replace(/[:.]/g,'-');
Â  a.download = `biocompare_table_${ts}.csv`;
Â  document.body.appendChild(a);
Â  a.click();
Â  a.remove();
Â  URL.revokeObjectURL(url);
});

/* click-to-copy for example IDs (individual) and a top-right copy button for both */
document.addEventListener('click', function(e){
Â  const target = e.target;

Â  // individual copy spans
Â  if (target && target.classList && target.classList.contains('copy-id')) {
Â  Â  const value = target.getAttribute('data-copy') || target.textContent;
Â  Â  if (!value) return;
Â  Â  navigator.clipboard.writeText(value).then(()=>{
Â  Â  Â  target.classList.add('copied');
Â  Â  Â  // tiny tooltip near the element
Â  Â  Â  const tip = document.createElement('div');
Â  Â  Â  tip.className = 'tooltip-copied';
Â  Â  Â  tip.textContent = 'Copied';
Â  Â  Â  document.body.appendChild(tip);
Â  Â  Â  const rect = target.getBoundingClientRect();
Â  Â  Â  tip.style.left = (rect.left + rect.width/2) + 'px';
Â  Â  Â  tip.style.top = (rect.top - 10) + 'px';
Â  Â  Â  requestAnimationFrame(()=>{ tip.style.opacity = '1'; tip.style.transform = 'translate(-50%, -10px)'; });
Â  Â  Â  setTimeout(()=>{ tip.style.opacity = '0'; tip.style.transform = 'translate(-50%, -6px)'; setTimeout(()=> tip.remove(), 200); }, 900);
Â  Â  Â  setTimeout(()=> target.classList.remove('copied'), 900);
Â  Â  }).catch(()=>{ /* ignore */ });
Â  Â  return;
Â  }

Â  // copy example button - copies both example IDs (does not auto-fill inputs)
Â  if (target && (target.id === 'copyExampleBtn' || (target.closest && target.closest('#copyExampleBtn')))) {
Â  Â  const exampleBox = document.querySelector('.example-box');
Â  Â  if (!exampleBox) return;
Â  Â  const spans = exampleBox.querySelectorAll('.copy-id');
Â  Â  const values = [];
Â  Â  spans.forEach(s => {
Â  Â  Â  const v = s.getAttribute('data-copy') || s.textContent;
Â  Â  Â  if (v && v.trim()) values.push(v.trim());
Â  Â  });
Â  Â  if (values.length === 0) return;
Â  Â  const toCopy = values.join('\t'); // copy both separated by a tab
Â  Â  navigator.clipboard.writeText(toCopy).then(()=>{
Â  Â  Â  // show floating tooltip near the button
Â  Â  Â  const btnEl = document.getElementById('copyExampleBtn');
Â  Â  Â  const btnRect = btnEl.getBoundingClientRect();
Â  Â  Â  const tip = document.createElement('div');
Â  Â  Â  tip.className = 'tooltip-copied';
Â  Â  Â  tip.textContent = 'Copied example IDs';
Â  Â  Â  document.body.appendChild(tip);
Â  Â  Â  tip.style.left = (btnRect.left + btnRect.width/2) + 'px';
Â  Â  Â  tip.style.top = (btnRect.top - 8) + 'px';
Â  Â  Â  requestAnimationFrame(()=>{ tip.style.opacity = '1'; tip.style.transform = 'translate(-50%, -10px)'; });
Â  Â  Â  setTimeout(()=>{ tip.style.opacity = '0'; tip.style.transform = 'translate(-50%, -6px)'; setTimeout(()=> tip.remove(), 200); }, 900);
Â  Â  }).catch(()=>{ /* ignore */ });
Â  Â  return;
Â  }
});
</script>

<pre id="example-ids" aria-hidden="true" style="position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden;white-space:pre;">
A: ENSG00000124610
B: ENSG00000168298
Example to see the intersection representation.
</pre>
</body>
</html>
